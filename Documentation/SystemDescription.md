# Sensors Unleashed

### Events
Events is something the device can post to the outside world.
An event can be disabled, in which case the event doesn't get posted.
Any device can trigger three types of events:

* (0 = No Event)
* 2 = Above Event
* 4 = Below Event
* 8 = Change Event

#### Trigger level
It is possible to tune on the values that will trigger an event. This may not make sense in all circumstances, but for some it is very neat. Take the pulse counter - if we want it to generate a change event for every 1000 pulses, we simply set the trigger level for the change event to 1000. The rest of the events can safely be disabled.

What triggers an event is specific to a sensor type â€“ e.g. a switch device will default trigger an above event on push, and a Below event on release. Behind the scenes, the trigger levels is set to 1 for on , 0 for below and 1 for change.

# Devices
There are 2 types of devices - sensors and actuators.
A sensor is characterized by measuring something on it inputs, and if within trigger limits post an event.
An actuator is only for setting its output. It listens for events, and sets its outputs accordingly.

## Sensors
Sensors are normally only used as input to an actuator. Only case where an action is needed in a sensor module, is when a sensor can be reset or externally triggered.

### Pushbutton
type: Sensor

The button is pure digital and default low. The input goes high when pressed.

#### Defaults:
* Above event level = 1
* Below event level = 0
* Change event level = 1

When the user pushes the button, an above event will be posted. The below event will be posted on button release. The change event is posted both on push and release. By subscribing to the below event the switch will function as a click button.

### Pulse counter
type: Sensor

The pulse counter, simply counts pulses. The device was made to count pulses generated by a electrical household power meter.

#### Defaults:
* Above event level = 1000
* Below event level = 0 and disabled
* Change event level = 1000

If one needs to measure energy, usually the change event will be used. Every time the event level is reached, the event will be posted.

### Mains detector
type: Sensor

The mains detector will act mostly as a regular switch device, but instead of a physical switch to trigger its actions, the mains supply will be monitored and used.

#### Defaults:
* Above event level = 1
* Below event level = 0
* Change event level = 1

## Actuators
Contrary sensors, actuators are devices that is ordered by another device to do some action. Actions is what a particular actuator device can do. A relay can be turned on, turned off or toggled. Each device type has a particular set of actions and each action can be set to trigger any of 3 event types.

### Relay
This actuator can be used to turn on and off some household appliances.

#### Actions
* 0 = Off
* 1 = On
* 2 = toggle

### LED
The led is a signaling device, most often used during development, or to indicate that something has happened that the user want to be notified about.

#### Actions
* 0 = Off
* 1 = On
* 2 = toggle

# Bindings
Its always the actuator that will request to be updated by changes from another actuator or sensor. It is not possible to pair 2 sensors, because a plain sensor has no action sink.
Bindings are set or reset using the configuration tool.

## Example 1 - A Push button turns on a relay
The Push button is left in its default setup. The relay will be asked to bind its toggle action to the push button below event. From now on, when the push button is pushed, the relay will toggle its state.

## Example 2 - A Push button turn on a relay - not off
The Push button is left in its default setup. The relay will be asked to bind its On action to the push button below event. From now on, when the push button is pushed, the relay will turn on. It will be up to another device to turn off again.

# Software Architecture

## Pairing
The entire pair/binding strategy is based entirely on the CoAP observe mechanism. The configuration tool will send the pairing informations as a CoAP message.

The observe pattern in CoAP makes it possible to subscribe to changes in an observing sensor.

Example:
We want to turn on a relay (actuator) when a push button (sensor) is pushed.
The configuration tool, will make the sensor generate a below event when pushed. Next it will request the relay to bind to the push button below event.



<!--
```C++
struct resourceconf {
	uint8_t id;
	uint32_t resolution;
	uint32_t version;
	uint8_t flags;
	int32_t max_pollinterval;
  uint8_t eventsActive;
  cmp_object_t AboveEventAt;
  cmp_object_t BelowEventAt;
  cmp_object_t ChangeEvent;
  cmp_object_t RangeMin;
  cmp_object_t RangeMax;
	char* unit;
	char* spec;
	char* type;
	char* group;
	char* attr;
};
```
-->

```C++
/* Used for extra material needed for using a sensor */
struct extras{
	int type;
	void* config;
	void* runtime;
	void* resource;
};

struct susensors_sensor {
	struct susensors_sensor* next;
	char *       type;

	unsigned char event_flag;
	int (* value) (struct susensors_sensor* this, int type, void* data);
	int (* configure) (struct susensors_sensor* this, int type, int value);
	int (* status) (struct susensors_sensor* this, int type, void* data);
	int (* eventhandler) (struct susensors_sensor* this, int len, uint8_t* payload);

	notification_callback_t notification_callback;

	int (* getActiveEventMsg) (struct susensors_sensor* this, uint8_t* payload);
	int (* suconfig) (struct susensors_sensor* this, int type, void* data);

	struct extras data;

	LIST_STRUCT(pairs);
};
```

## Sensor


## Actuator

The actuator is able to tie up events to actions.

```C++
struct suaction_ptrs {
  void (* onAboveEvent) (void);
  void (* onBelowEvent) (void);
  void (* onChangeEvent)(void);
}
```

An action is attached to any of the 3 events by assigning the function pointer to the action chosen.  When one of the events is received the function pointer is called, and the action executed. If the action pointer is 0, the action has not been paired.

# Coap
This is the entry point for any device, and from here readings can be requested, configuration changed and so forth.

## Commands
### Get
#### Config
#### Pairings


* AboveEventAt
* BelowEventAt
* ChangeEventAt
* RangeMin
* RangeMax
* getEventState
* getEventSetup
* pairings

Without any query specified, the current value will be returned.

### Put
#### setCommand
#### eventsetup
payload contains
#### pairRemoveIndex
This command removes the pair at index.
#### pairRemoveAll
This command emoves all observees in the list.
#### join
This command adds sensor/actuator pair to the unit. The join message can span over multiple blocks of payloads. The actuator will use these information to setup a CoAP observer link to the sensor source.

Payload:
* <b>Sensor source IP
* <b>URL of the sensor source
* <b>Eventtriggers
This is 3 bytes array
```C++
[0] = Above event action pointer
[1] = Below event action pointer
[2] = Change event action pointer
```
The pointers refer to the action enum of the actuator

* <b>(Perhaps we need to add a port as well)

To setup an observer link, the ip and url is needed.
Example:
Listen for above events:
coap://ip/su/puls ecounter/above

### Post
All events has the sensor value attached in the payload. Use it or don't.
* AboveEvent
* BelowEvent
* ChangeEvent

If the received command is attached to an action, this action will get called. This interface is only provided for testing purposes.

## Configuration storage
